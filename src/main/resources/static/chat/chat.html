<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ…</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div id="rulebook-overlay" onclick="toggleRulebook(false)"></div>
<div id="rulebook-modal">
    <h4>ë§ˆí”¼ì•„ ê²Œì„ ë£°ë¶</h4>
    <ul>
        <li>ë‚®: 120ì´ˆ í† ë¡  í›„ íˆ¬í‘œë¡œ ë§ˆí”¼ì•„ë¥¼ ì§€ëª©</li>
        <li>ë°¤: ë§ˆí”¼ì•„ëŠ” ì‹œë¯¼ì„ ì œê±°</li>
        <li>ê²½ì°°: ë°¤ì— ì„ íƒí•œ ìœ ì €ì˜ ì§ì—… í™•ì¸ ê°€ëŠ¥</li>
        <li>ì˜ì‚¬: ë°¤ì— ì„ íƒí•œ í•œ ëª…ì„ ë³´í˜¸ ê°€ëŠ¥</li>
        <li>ëª¨ë“  ë§ˆí”¼ì•„ê°€ ì œê±°ë˜ë©´ ì‹œë¯¼ ìŠ¹ë¦¬</li>
        <li>ì‹œë¯¼ ìˆ˜ê°€ ë§ˆí”¼ì•„ ìˆ˜ë³´ë‹¤ ê°™ê±°ë‚˜ ì ì–´ì§€ë©´ ë§ˆí”¼ì•„ ìŠ¹ë¦¬</li>
    </ul>
</div>
<div id="vote-modal" class="modal">
  <div class="modal-content">
    <h3>íˆ¬í‘œí•  í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
    <ul id="vote-list"></ul>
    <button onclick="submitVote()" class="vote-button">íˆ¬í‘œí•˜ê¸°</button>
  </div>
</div>


<div class="sidebar">
    <button onclick="toggleRulebook(true)">ë£°ë¶ ë³´ê¸°</button>
    <div id="timer">ë‚¨ì€ ì‹œê°„: <span id="time">120</span>ì´ˆ</div>
    <button onclick="endTimerNow()">ì‹œê°„ ì¡°ê¸° ì¢…ë£Œ</button>

    <h4>ì°¸ì—¬ì ëª©ë¡</h4>
    <ul id="participant-list" class="participant-list"></ul>
</div>

<div class="main">
    <header>ì±„íŒ…ë°©</header>
    <div id="chat-box"></div>
    <footer>
        <textarea id="message" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" rows="1" style="resize: none; width: 100%;"></textarea>
        <button onclick="sendMessage()">ì „ì†¡</button>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    const roomId = "room123";
    const sender = sessionStorage.getItem("username") || "ìµëª…";
    sessionStorage.setItem("username", sender);

    const socket = new SockJS("/ws/chat");
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, () => {
        stompClient.subscribe("/topic/chat/" + roomId, (msg) => {
            const data = JSON.parse(msg.body);
            const isMe = sender === data.sender;
            
            console.log("ğŸ’¬ ìˆ˜ì‹  ë©”ì‹œì§€:", data);
            if (data.type === "TALK") {
                displayMessage(data.sender, data.message, isMe);
            } else if (data.type === "ENTER" || data.type === "LEAVE") {
                displayNotice(data.message); 
            }

            if (data.participants) {
                updateParticipantList(data.participants); 
            }
        });

        stompClient.send("/app/chat.send/" + roomId, {}, JSON.stringify({
            roomId: roomId,
            sender: sender,
            message: "",
            type: "ENTER"
        }));
    });

    

    window.addEventListener("beforeunload", () => {
        stompClient.send("/app/chat.send/" + roomId, {}, JSON.stringify({
            roomId: roomId,
            sender: sender,
            message: "",
            type: "LEAVE"
        }));
    });

    function sendMessage() {
        if (timeLeft <= 0) return;

        const message = document.getElementById("message").value;
        if (!message.trim()) return;

        stompClient.send("/app/chat.send/" + roomId, {}, JSON.stringify({
            roomId: roomId,
            sender: sender,
            message: message,
            type: "TALK"
        }));

        document.getElementById("message").value = '';
    }

    function displayMessage(sender, message, isMe) {
        const chatBox = document.getElementById("chat-box");
        const msgDiv = document.createElement("div");
        msgDiv.className = "message " + (isMe ? "right" : "left");
        msgDiv.innerHTML = `<div class="sender">${sender}</div><div class="message-content">${message
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\n/g, '<br>&ZeroWidthSpace;')}</div>`;

        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    function displayNotice(message) {
        if (!message || message.trim() === "") return; 

        const chatBox = document.getElementById("chat-box");
        const msgDiv = document.createElement("div");
        msgDiv.className = "notice";
        msgDiv.innerHTML = `<div class="message-notice">${message}</div>`;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function toggleRulebook(show) {
        const modal = document.getElementById("rulebook-modal");
        const overlay = document.getElementById("rulebook-overlay");
        modal.style.display = show ? 'block' : 'none';
        overlay.style.display = show ? 'block' : 'none';
    }

    let timeLeft = 120;
    const timeSpan = document.getElementById("time");
    const timer = setInterval(() => {
        if (timeLeft > 0) {
            timeLeft--;
            timeSpan.textContent = timeLeft;
        } else {
            clearInterval(timer);
            alert("ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            showVoteModal(latestParticipants);
        }
    }, 1000);

    function endTimerNow() {
        timeLeft = 0;
        timeSpan.textContent = 0;
        clearInterval(timer);
        alert("ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
        showVoteModal(latestParticipants);
    }

    document.getElementById("message").addEventListener("keydown", function(event) {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });

    let latestParticipants = [];

    function updateParticipantList(participants) {
        latestParticipants = participants;
        const list = document.getElementById("participant-list");
        list.innerHTML = '';
        participants.forEach(p => {
            const item = document.createElement("li");
            item.textContent = p;
            list.appendChild(item);
        });
    }

    function showVoteModal(participants) {
    	console.log("ğŸ‘¥ íˆ¬í‘œ ëŒ€ìƒì:", participants);
        const voteList = document.getElementById("vote-list");
        voteList.innerHTML = '';
        participants.forEach(name => {
            if (name === sender) return; 
            const li = document.createElement("li");
            li.textContent = name;
            li.onclick = () => {
                document.querySelectorAll("#vote-list li").forEach(el => el.classList.remove("selected"));
                li.classList.add("selected");
                li.setAttribute("data-selected", "true");
            };
            voteList.appendChild(li);
        });
        document.getElementById("vote-modal").style.display = "flex";
    }

    function submitVote() {
        const selected = document.querySelector("#vote-list li.selected");
        if (!selected) {
            alert("íˆ¬í‘œ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”.");
            return;
        }

        const votedUser = selected.textContent;

        stompClient.send("/app/chat.vote/" + roomId, {}, JSON.stringify({
            sender: sender,
            voted: votedUser,
            type: "VOTE"
        }));

        document.getElementById("vote-modal").style.display = "none";
    }

</script>
</body>
</html>
