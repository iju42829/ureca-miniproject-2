<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>친구 초대</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
            crossorigin="anonymous"></script>
</head>
<body>
	<p>로그인된 사용자: <span id="loggedInEmail">불러오는 중...</span></p>

    <h1>친구 초대</h1>

    <form id="inviteFriendForm">
        <label for="inviteeEmail">초대할 친구 이메일:</label>
        <input type="text" id="inviteeEmail" name="inviteeEmail" required><br><br>

        <input type="hidden" name="_csrf" id="_csrf" value="">

        <button type="submit">초대 보내기</button>
    </form>

    <div id="message" class="message"></div>

  	<h2>받은 친구 요청</h2>
    <div id="inviteListContainer"></div>



	<h2>친구 목록</h2>
	<div id="friendListContainer"></div>




    <script>

	    function loadFriendRequests() {

			//waiting 중인 친구 요청 list up	    
			const statusDesired = 'WAITING'; 
	        $.ajax({
	            url: '/api/friend/status',
	            type: 'GET',	   
	            data: { statusDesired: statusDesired },
	            success: function (response) {
                    const inviteList = response.data.invitesList;                    
                    const container = $('#inviteListContainer');
                    container.empty();
					console.log(inviteList)

                    if ( inviteList.length === 0) {
                        container.append('<p>받은 친구 요청이 없습니다.</p>');
                        return;
                    }

                    inviteList.forEach(friend => {
                        const inviterName = friend.friendId.inviter.userName;
                        const inviterEmail = friend.friendId.inviter.email;
                        const status = friend.status;

                        const item = `

                            <div class="invite-item">
                                <p>보낸 사람: ${inviterName} (${inviterEmail}) - 상태: ${status}</p>
                                <button class="accept-btn" data-email="${inviterEmail}">수락</button>
                                <button class="decline-btn" data-email="${inviterEmail}">거절</button>
                            </div>
                        `;
                        container.append(item);
                    });
                },
                error: function () {
                    alert('친구 요청 목록을 불러오는 데 실패했습니다.');
                }

	        });

	        
	     // 친구 요청 거절
	        $(document).on('click', '.decline-btn', function () {
	            const $btn = $(this);
	            const inviterEmail = $btn.data('email');
	            const csrfToken = $('#_csrf').val();

	            $.ajax({
	                url: '/api/friend',
	                type: 'PUT',
	                contentType: 'application/json',
	                data: JSON.stringify({ 
	                    inviterEmail: inviterEmail, 
	                    statusDesired: 'DECLINED' 
	                }),
	                beforeSend: function (xhr) {
	                    xhr.setRequestHeader('X-XSRF-TOKEN', csrfToken);
	                },
	                success: function () {
	                    alert('거절 완료');
	                    $btn.closest('.invite-item').remove(); // 해당 항목 제거
	                    location.reload();
	                },
	                error: function () {
	                    alert('거절 실패');
	                }
	            });
	        });

	    }
	    // 친구 요청 수락        
        $(document).on('click', '.accept-btn', function () {
            const inviterEmail = $(this).data('email');
            const csrfToken = $('#_csrf').val();
            $.ajax({
                url: '/api/friend',
                type: 'PUT',
                contentType: 'application/json',               
                data: JSON.stringify({ 
                    inviterEmail: inviterEmail, 
                    statusDesired: 'ACCEPTED' 
                }),
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-XSRF-TOKEN', csrfToken); // CSRF 토큰 추가
                },
                success: function () {
                    alert('수락 완료');
//                     $btn.closest('.invite-item').remove(); // 해당 친구 요청만 삭제
                    location.reload();
                },
                error: function () {
                    alert('수락 실패');
                }
            });
        });

        $(document).ready(function () {
            // CSRF 토큰 가져오기
            fetch('/csrf-token', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(res => res.json())
            .then(data => {
                $('#_csrf').val(data.token); // CSRF 토큰 값 설정
            });



            let loggedInEmail = '';

            fetch('/api/user/me', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(res => res.json())
            .then(result => {
                const data = result.data;
                loggedInEmail = data.email;
                $('#loggedInEmail').text(`${data.userName} (${data.email})`);
            })
            .catch(() => {
                $('#loggedInEmail').text("로그인된 사용자를 불러오지 못했습니다.");
            });

            
            loadFriendRequests();
            loadFriendList();      
            // 폼 제출 이벤트 처리
            $('#inviteFriendForm').submit(function (e) {
                e.preventDefault();

                const inviteeEmail = $('#inviteeEmail').val();
                const csrfToken = $('#_csrf').val();
                const messageDiv = $('#message');

                if (!inviteeEmail) {
                    messageDiv.css('color', 'red').text("이메일을 입력해주세요.");
                    return;
                }

                $.ajax({

                    url: '/api/friend',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ inviteeEmail: inviteeEmail }),

                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('X-XSRF-TOKEN', csrfToken); // CSRF 토큰 추가
                    },

                    success: function (response) {
                        messageDiv.css('color', 'green').text("초대가 성공적으로 전송되었습니다.");
                        $('#inviteeEmail').val(''); // 이메일 입력 필드 초기화                        
                    },

                    error: function (xhr) {
                        const res = xhr.responseJSON;
                        messageDiv.css('color', 'red').text("초대 실패: " + res.message);
                        console.log(xhr.status);
                        if (xhr.status != 201) {
                            const res = xhr.responseJSON;
                            messageDiv.css('color', 'red').text("초대 실패:" + res.message );
                        }else if(xhr.status === 409){
                        	const res = xhr.responseJSON;
                            messageDiv.css('color', 'red').text("초대 실패:" + res.message);
                        }else if(xhr.status===406){
                        	const res = xhr.responseJSON;
                            messageDiv.css('color', 'red').text("초대 실패:" + res.message);
                        }else {
                            // 다른 상태 코드 처리
                            messageDiv.css('color', 'red').text("알 수 없는 오류가 발생했습니다.");
                        }
                    }
                });
            });
        });
        //친구들 listup
        function loadFriendList() {
		    $.ajax({
		        url: '/api/friend',
		        type: 'GET',
		        success: function (response) {
		            const friendList = response.data.friendList;
		            const container = $('#friendListContainer');
		            container.empty();
		            console.log(friendList);
		
		            if (friendList.length === 0) {
		                container.append('<p>친구가 없습니다.</p>');
		                return;
		            }
		
		            friendList.forEach(friend => {
		                const friendName = friend.userName;
		                const friendEmail = friend.email;
		
		                const item = `
		                    <div class="friend-item">
		                        <p>${friendName} (${friendEmail})</p>
		                        <button class="delete-btn" data-email="${friendEmail}">삭제</button>
		                    </div>
		                `;
		                container.append(item);
		            });
		        },
		        error: function () {
		            alert('친구 목록을 불러오는 데 실패했습니다.');
		        }
		    });
		    
		 	// 친구 삭제 버튼 이벤트
		    $(document).on('click', '.delete-btn', function () {
		        const emailToDelete = $(this).data('email');
		        const csrfToken = $('#_csrf').val();

		        if (!confirm(`${emailToDelete} 친구를 삭제하시겠습니까?`)) return;

		        $.ajax({
		            url: '/api/friend',
		            type: 'DELETE',		            
		            data: {emailToDelete: emailToDelete },
		            beforeSend: function (xhr) {
		                xhr.setRequestHeader('X-XSRF-TOKEN', csrfToken);
		            },
		            success: function () {
		                alert('친구가 삭제되었습니다.');
		                loadFriendList(); // 목록 갱신
		            },
		            error: function () {
		                alert('친구 삭제에 실패했습니다.');
		            }
		        });
		    });

		}


    </script>
</body>
</html>